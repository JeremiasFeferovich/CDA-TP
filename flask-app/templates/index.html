<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Predicción de Precio de Propiedad</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <h1>Predicción de Precio de Propiedad</h1>
  <form id="prediction-form" method="post">
    <label for="area">Área (m²):</label>
    <input type="number" name="area" step="any" value="{{ valores.get('area', '') }}" required>
    
    <label for="bedrooms">Dormitorios:</label>
    <input type="number" name="bedrooms" value="{{ valores.get('bedrooms', '') }}" required>
    
    <label for="bathrooms">Baños:</label>
    <input type="number" name="bathrooms" step="any" value="{{ valores.get('bathrooms', '') }}" required>
    
    <label for="location">Ubicación:</label>
    <div id="map"></div>
    <input type="hidden" name="latitude" id="latitude" value="{{ valores.get('latitude', '') }}" required>
    <input type="hidden" name="longitude" id="longitude" value="{{ valores.get('longitude', '') }}" required>
    <div id="coordinates-display" style="margin-top: 0.5em; font-size: 0.9em; color: #666;">
      {% if valores.get('latitude') and valores.get('longitude') %}
        Latitud: {{ valores.get('latitude') }}, Longitud: {{ valores.get('longitude') }}
      {% else %}
        Haz clic en el mapa para seleccionar una ubicación
      {% endif %}
    </div>
    
    <label for="property_type">Tipo de Propiedad:</label>
    <select name="property_type" required>
      {% for pt in property_types %}
        <option value="{{ pt }}" {% if valores.get('property_type') == pt %}selected{% endif %}>{{ pt.capitalize() }}</option>
      {% endfor %}
    </select>
    
    <label for="balcony_count">Cantidad de Balcones:</label>
    <input type="number" name="balcony_count" value="{{ valores.get('balcony_count', '0') }}" min="0">
    
    <label for="segment">Segmento de Precio:</label>
    <select name="segment" required>
      {% for seg in segments %}
        {% set info = segment_info.get(seg, {}) %}
        <option value="{{ seg }}" {% if valores.get('segment') == seg %}selected{% endif %}>
          {{ info.get('display', info.get('name_es', seg.replace('_', ' ').title())) }}
        </option>
      {% endfor %}
    </select>
    
    <input type="submit" value="Predecir Precio" id="submit-btn">
  </form>

  <div id="resultado-container"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Coordenadas de Buenos Aires (centro por defecto)
    const BUENOS_AIRES_CENTER = [-34.6037, -58.3816];
    
    // Inicializar mapa
    const map = L.map('map').setView(BUENOS_AIRES_CENTER, 12);
    
    // Agregar capa de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);
    
    // Variables para el marcador
    let marker = null;
    const latitudeInput = document.getElementById('latitude');
    const longitudeInput = document.getElementById('longitude');
    const coordinatesDisplay = document.getElementById('coordinates-display');
    
    // Función para actualizar coordenadas
    function updateCoordinates(lat, lng) {
      latitudeInput.value = lat.toFixed(6);
      longitudeInput.value = lng.toFixed(6);
      coordinatesDisplay.textContent = `Latitud: ${lat.toFixed(6)}, Longitud: ${lng.toFixed(6)}`;
    }
    
    // Manejar clic en el mapa
    map.on('click', function(e) {
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;
      
      // Remover marcador anterior si existe
      if (marker) {
        map.removeLayer(marker);
      }
      
      // Agregar nuevo marcador
      marker = L.marker([lat, lng]).addTo(map);
      
      // Actualizar campos del formulario
      updateCoordinates(lat, lng);
    });
    
    // Restaurar ubicación si hay valores existentes
    const existingLat = parseFloat(latitudeInput.value);
    const existingLng = parseFloat(longitudeInput.value);
    
    if (!isNaN(existingLat) && !isNaN(existingLng)) {
      map.setView([existingLat, existingLng], 15);
      marker = L.marker([existingLat, existingLng]).addTo(map);
      updateCoordinates(existingLat, existingLng);
    }
    
    // Manejar envío del formulario con AJAX
    const form = document.getElementById('prediction-form');
    const resultadoContainer = document.getElementById('resultado-container');
    const submitBtn = document.getElementById('submit-btn');
    
    form.addEventListener('submit', async function(e) {
      e.preventDefault(); // Prevenir recarga de página
      
      // Validar que se haya seleccionado una ubicación
      if (!latitudeInput.value || !longitudeInput.value) {
        resultadoContainer.innerHTML = '<div class="resultado error">Por favor, selecciona una ubicación en el mapa</div>';
        return;
      }
      
      // Mostrar estado de carga
      submitBtn.disabled = true;
      submitBtn.value = 'Calculando...';
      resultadoContainer.innerHTML = '<div class="resultado loading">Calculando precio estimado...</div>';
      
      // Recopilar datos del formulario
      const formData = {
        area: parseFloat(document.querySelector('input[name="area"]').value),
        bedrooms: parseInt(document.querySelector('input[name="bedrooms"]').value),
        bathrooms: parseFloat(document.querySelector('input[name="bathrooms"]').value),
        latitude: parseFloat(latitudeInput.value),
        longitude: parseFloat(longitudeInput.value),
        property_type: document.querySelector('select[name="property_type"]').value,
        balcony_count: parseInt(document.querySelector('input[name="balcony_count"]').value || 0),
        segment: document.querySelector('select[name="segment"]').value
      };
      
      try {
        // Enviar petición AJAX
        const response = await fetch('/predict', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Error al calcular el precio');
        }
        
        // Mostrar resultado
        const price = new Intl.NumberFormat('es-AR', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(data.prediction);
        
        resultadoContainer.innerHTML = `
          <div class="resultado">
            <strong>Precio Estimado:</strong> ${price}
          </div>
        `;
        
      } catch (error) {
        resultadoContainer.innerHTML = `<div class="resultado error">Error: ${error.message}</div>`;
      } finally {
        // Restaurar botón
        submitBtn.disabled = false;
        submitBtn.value = 'Predecir Precio';
      }
    });
  </script>
</body>
</html>
